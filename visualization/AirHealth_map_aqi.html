<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AirHealth: U.S. Air Quality & Health Impact Dashboard</title>
  <script src="./lib/d3.v5.min.js"></script>
  <style>
    :root {
      --bg: #f8fafc;
      --ink: #0f172a;
      --muted: #64748b;
      --card: #ffffff;
      --accent: #2563eb;
      --border: #e5e7eb;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans', Ubuntu, Cantarell, 'Helvetica Neue', Arial;
      color: var(--ink);
      background: radial-gradient(1200px 600px at 30% 0%, #eef2ff 0%, var(--bg) 40%);
    }
    .wrap { max-width: 1200px; margin: 24px auto 40px; padding: 0 16px; }
    h1 { margin: 0 0 10px; font-size: 20px; font-weight: 700; letter-spacing: 0.2px; }
    .toolbar { display: grid; grid-template-columns: auto auto 1fr; gap: 16px; align-items: center; }
    .controls { display: flex; gap: 12px; align-items: center; }
    .select { position: relative; }
    select {
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      border: 1px solid var(--border); background: var(--card);
      border-radius: 12px; padding: 10px 40px 10px 14px; font-size: 14px; color: var(--ink);
      box-shadow: 0 1px 1px rgba(16,24,40,.04), 0 1px 2px rgba(16,24,40,.06);
      outline: none;
    }
    .select:after {
      content: '\25BE';
      position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      color: var(--muted); pointer-events: none; font-size: 14px;
    }
    .select.small select {
      padding: 6px 28px 6px 10px;
      font-size: 12px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
    }
    .layout { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-top: 14px; }
    .mapPanel { position: relative; }

    .map-main-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .map-sub-title {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    svg { width: 100%; height: auto; display: block; }
    .state { fill: #e5edf5; stroke: #ffffff; stroke-width: 1; cursor: pointer; }
    .state:hover { filter: brightness(0.95); }
    .abbr {
      font: 11px/1.1 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      fill: #0f172a;
      text-anchor: middle;
      pointer-events: none;
    }

    /* Slider */
    .sliderWrap {
      padding: 10px 14px 10px 10px;
      grid-column: 1 / -1;
      height: 70px;
      display: flex;
      flex-direction: column;
    }
    .sliderTitle { font-size: 14px; margin-bottom: 8px; font-weight: 600; letter-spacing: .02em; }
    .slider svg { width: 100%; height: 70px; }
    .track { stroke: #e2e8f0; stroke-linecap: round; stroke-width: 6; }
    .track-inset { stroke: #f8fafc; stroke-width: 4; }
    .track-overlay { pointer-events: stroke; stroke-width: 36; cursor: ew-resize; opacity: 0; }
    .handle { fill: var(--card); stroke: var(--accent); stroke-width: 2.5; }
    .tick text { font-size: 11px; fill: var(--muted); transform: translateY(-10px); }

    .pop {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      pointer-events: none;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, .14);
      padding: 10px 10px 8px;
      min-width: 220px;
      max-width: 260px;
      transform: translate(-50%, -100%);
      display: none;
    }
    .pop .title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .pop .sub {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .pop .legend {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      margin-bottom: 4px;
    }
    .pop .legend i {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 2px;
      margin-right: 6px;
    }
    .pop .legend .a { background: #93c5fd; }
    .pop .legend .c { background: #facc15; }
    .pop .legend .i { background: #f9a8d4; }

    .bar.asthma { fill: #93c5fd; }
    .bar.copd  { fill: #facc15; }
    .bar.ihd   { fill: #f9a8d4; }

    .axis text { font-size: 10px; fill: var(--muted); }
    .axis path, .axis line { stroke: #e5e7eb; }

    #lineChartPanel {
        width: 780px;
        height: 500px;
    }

    /* Radar panel */
    #radarPanel {
      min-height: 260px;
      width: 460px;
      max-width: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 4px;
    }
    .radar-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 0;
    }
    .radar-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 4px;
    }
    .aqi-legend {
    margin-top: 4px;
    padding-top: 4px;
    font-size: 11px;
    color: #64748b;
    }

    .aqi-legend-title {
    margin-top: 4px;
    font-size: 11px;
    font-weight: 600;
    color: #475569;
    margin-bottom: 2px;
    }

    .aqi-legend-label {
    font-size: 9px;
    fill: #0f172a;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AirHealth: U.S. Air Quality & Health Impact Dashboard</h1>
    <div class="toolbar">
      <div class="controls">
        <div class="select">
          <select id="pollutant">
            <option value="" selected disabled>Pollutants</option>
            <option value="pm25">PM₂.₅ (Fine Particulate)</option>
            <option value="pm10">PM₁₀ (Coarse Particulate)</option>
            <option value="o3">O₃ (Ozone)</option>
            <option value="no2">NO₂ (Nitrogen Dioxide)</option>
            <option value="co">CO (Carbon Monoxide)</option>
            <option value="so2">SO₂ (Sulfur Dioxide)</option>
          </select>
        </div>
        <div class="select">
          <select id="year">
            <option value="" selected disabled>Year</option>
          </select>
        </div>
      </div>
      <div class="card sliderWrap">
        <div class="sliderTitle">Month</div>
        <div id="month-slider" class="slider"></div>
      </div>
    </div>

    <!-- 상단: 지도 + 레이더 -->
    <div class="layout">
      <div class="card mapPanel">
        <div class="map-main-title">U.S. Air Quality Choropleth Map</div>
        <div class="map-sub-title">Select pollutant, year & month to explore trends</div>
        <svg id="map" viewBox="0 0 960 600" aria-label="US States map"></svg>

        <!-- Tooltip popover -->
        <div id="pop" class="pop" role="tooltip" aria-live="polite">
          <div class="title" id="pop-title"></div>
          <div class="sub" id="pop-sub"></div>

          <!-- 항상 보이는 질병 legend -->
          <div class="legend" id="disease-legend">
            <span><i class="a"></i>Asthma</span>
            <span><i class="c"></i>COPD</span>
            <span><i class="i"></i>IHD</span>
          </div>

          <div id="pollutant-info" style="font-size:11px; color:var(--muted); margin-top:2px; margin-bottom:4px;"></div>

          <svg id="pop-chart" width="240" height="150" aria-label="Mortality mini chart"></svg>
        </div>

        <!-- Pollutant color legend -->
        <div id="color-legend"
             style="margin-top: 14px; background: var(--card); border: 1px solid var(--border);
                    border-radius: 12px; padding: 10px 14px; display: none; pointer-events: none;
                    width: fit-content; margin-left: auto; margin-right: 0;">
          <div id="legend-title"
               style="font-size: 11px; font-weight: 600; margin-bottom: 6px; color: var(--muted);">
            PM₂.₅ (μg/m³)
          </div>
          <svg id="legend-gradient" width="180" height="12" style="margin-bottom: 4px;"></svg>
          <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--muted);">
            <span id="legend-min">0</span>
            <span id="legend-max">15</span>
          </div>
        </div>
      </div>

      <!-- 오른쪽 상단: AQI 레이더 (독립 컨트롤) -->
      <div class="card" id="radarPanel">
        <div class="radar-title">AQI Forecast through 2030 (by Pollutant)</div>
        <div class="radar-controls">
          <div class="select small">
            <select id="radarState">
              <option value="" disabled selected>State</option>
            </select>
          </div>
          <div class="select small">
            <select id="radarYear">
              <option value="" disabled selected>Year</option>
            </select>
          </div>
          <div class="select small">
            <select id="radarMonth">
              <option value="1">JAN</option>
              <option value="2">FEB</option>
              <option value="3">MAR</option>
              <option value="4">APR</option>
              <option value="5">MAY</option>
              <option value="6">JUN</option>
              <option value="7">JUL</option>
              <option value="8">AUG</option>
              <option value="9">SEP</option>
              <option value="10">OCT</option>
              <option value="11">NOV</option>
              <option value="12">DEC</option>
            </select>
          </div>
        </div>
        <svg id="aqiLineChart" width="420" height="160"></svg>
        <svg id="radarChart" width="420" height="260"></svg>
        <div id="aqi-legend" class="aqi-legend">
        <div class="aqi-legend-title">Air Quality Index (AQI)</div>
        <svg id="aqiLegendSvg" width="420" height="40"></svg>
      </div>
    </div>

    <!-- 하단: Mortality line chart -->
    <div class="layout">
      <div class="card" id="lineChartPanel">
        <div class="select" style="margin-bottom:12px; width:180px;">
          <select id="state">
            <option value="" selected disabled>State</option>
          </select>
        </div>
        <svg id="lineChart" width="700" height="460"></svg>
      </div>
    </div>
  </div>

<script>
(function() {
  // ----- Year dropdown (지도/라인차트용) -----
  var years = d3.range(2018, 2026);
  var yearSel = d3.select('#year');
  yearSel.selectAll('option.yr')
    .data(years)
    .enter().append('option')
    .attr('class','yr')
    .attr('value', String)
    .text(String);

  // ----- Month slider -----
  var months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  var sliderSVG, gS, x, handle, activeMonth;

  function drawSlider() {
    d3.select('#month-slider').selectAll('svg').remove();

    var mapW = document.querySelector('.mapPanel').getBoundingClientRect().width;
    var sliderW = Math.max(300, Math.floor(mapW));
    var sliderH = 60;
    var margin = {left: 24, right: 30, top: 16, bottom: 16};
    var innerW = sliderW - margin.left - margin.right;

    sliderSVG = d3.select('#month-slider').append('svg')
      .attr('width', sliderW)
      .attr('height', sliderH);

    gS = sliderSVG.append('g').attr('transform', 'translate(' + margin.left + ',30)');

    x = d3.scalePoint().domain(months).range([0, innerW]).padding(0.5);
    var xIdx = d3.scaleLinear().domain([0, months.length - 1]).range([0, innerW]).clamp(true);

    function clampPx(px) { return Math.max(x.range()[0], Math.min(x.range()[1], px)); }

    function smoothDrag(pxAbs) {
      var local = clampPx(pxAbs - margin.left);
      var idx = xIdx.invert(local);
      handle.attr('cx', xIdx(idx));
    }

    function snapToNearest(pxAbs) {
      var local = clampPx(pxAbs - margin.left);
      var idx = xIdx.invert(local);
      var i = Math.round(idx);
      i = Math.max(0, Math.min(months.length - 1, i));
      activeMonth = months[i];
      handle.attr('cx', x(activeMonth));
      var detail = { month: activeMonth, index: i };
      var ev = new CustomEvent('monthchange', { detail: detail });
      document.body.dispatchEvent(ev);
    }

    gS.append('line').attr('class','track')
      .attr('x1', x.range()[0]).attr('x2', x.range()[1])
      .attr('y1',0).attr('y2',0);
    gS.append('line').attr('class','track-inset')
      .attr('x1', x.range()[0]).attr('x2', x.range()[1])
      .attr('y1',0).attr('y2',0);

    var overlay = gS.append('line').attr('class','track-overlay')
      .attr('x1', x.range()[0]).attr('x2', x.range()[1])
      .attr('y1',0).attr('y2',0);
    overlay.call(d3.drag()
      .on('start drag', function() { smoothDrag(d3.event.x); })
      .on('end', function() { snapToNearest(d3.event.x); })
    );

    gS.append('g').attr('class','axis axis--x')
      .call(d3.axisBottom(x).tickSize(0))
      .selectAll('text').attr('dy', -10);

    var initialIdx = 0;
    activeMonth = months[initialIdx];
    handle = gS.append('circle')
      .attr('class','handle').attr('r', 10)
      .attr('cy', 0).attr('cx', x(activeMonth));

    handle.call(d3.drag()
      .on('start drag', function() { smoothDrag(d3.event.x); })
      .on('end', function() { snapToNearest(d3.event.x); })
    );
  }

  function alignSliderBox() {
    var wrap = document.querySelector('.wrap');
    var map = document.querySelector('.mapPanel');
    var sliderBox = document.querySelector('.sliderWrap');
    if (!wrap || !map || !sliderBox) return;
    var wrapRect = wrap.getBoundingClientRect();
    var mapRect = map.getBoundingClientRect();
    sliderBox.style.width = (mapRect.width - 30) + 'px';
    sliderBox.style.marginLeft = (mapRect.left - wrapRect.left - 16) + 'px';
  }
  function reflowSlider() { alignSliderBox(); drawSlider(); }

  reflowSlider();
  window.addEventListener('resize', reflowSlider);

  document.body.addEventListener('monthchange', function(e){
    console.log('[Month changed]', e.detail);
    updateMapColors();   // 레이더는 독립이므로 건들지 않음
  });

  // ----- Map rendering -----
  var mapSvg = d3.select('#map');
  var gMap = mapSvg.append('g');

  var projection = d3.geoAlbersUsa().translate([480, 300]).scale(1150);
  var path = d3.geoPath().projection(projection);

  d3.json('./data/us-states.json').then(function(geo) {
    var states = geo.features;

    gMap.selectAll('path.state')
      .data(states)
      .enter().append('path')
      .attr('class', 'state')
      .attr('d', path);

    gMap.selectAll('text.abbr')
      .data(states)
      .enter().append('text')
      .attr('class','abbr')
      .attr('transform', function(d){
        var c = path.centroid(d);
        return 'translate(' + (isFinite(c[0]) ? c[0] : -9999) + ',' + (isFinite(c[1]) ? c[1] : -9999) + ')';
      })
      .attr('dy', 3)
      .text(function(d){ return d.id || ''; });
  }).catch(function(err){
    console.error('Failed to load GeoJSON. Make sure ./data/us-states.json exists.', err);
  });

  // ----- Tooltip popover -----
  var pop = document.getElementById('pop');
  var popTitle = document.getElementById('pop-title');
  var popSub = document.getElementById('pop-sub');
  var popSvg = d3.select('#pop-chart');

  function showPop() { pop.style.display = 'block'; }
  function hidePop() { pop.style.display = 'none'; }
  function movePop(evt) {
    const panel = document.querySelector('.mapPanel').getBoundingClientRect();
    const popRect = pop.getBoundingClientRect();
    const x = evt.clientX - panel.left + 14;
    const y = evt.clientY - panel.top - 10;
    const left = Math.min(Math.max(8, x), panel.width - popRect.width - 8);
    const top = Math.min(Math.max(8, y), panel.height - popRect.height - 8);
    pop.style.left = left + 'px';
    pop.style.top = top + 'px';
  }

  // ----- Pollutant data for choropleth -----
  var pollutantData = { pm25: new Map(), pm10: new Map(), no2: new Map(), o3: new Map(), co: new Map(), so2: new Map() };
  var yearRanges = { pm25: new Map(), pm10: new Map(), no2: new Map(), o3: new Map(), co: new Map(), so2: new Map() };

  function convertMonthFormat(monthStr) { return monthStr.replace('-', '/'); }
  function getYearFromMonthCode(monthCode) { return monthCode.split('/')[0]; }

  function loadPollutantData(label, csvPath, pollutantKey) {
    return d3.csv(csvPath).then(function(data) {
      console.log('[' + label + ' data] Loaded', data.length, 'rows');
      var valuesByYear = new Map();

      data.forEach(function(d) {
        var monthCode = convertMonthFormat(d.Month);
        var year = getYearFromMonthCode(monthCode);
        var value = +d['Arithmetic Mean'] || 0;

        if (!pollutantData[pollutantKey].has(monthCode)) {
          pollutantData[pollutantKey].set(monthCode, new Map());
        }
        pollutantData[pollutantKey].get(monthCode).set(d['State Name'], value);

        if (!valuesByYear.has(year)) valuesByYear.set(year, []);
        valuesByYear.get(year).push(value);
      });

      valuesByYear.forEach(function(values, year) {
        var min = d3.min(values);
        var max = d3.max(values);
        yearRanges[pollutantKey].set(year, {min: min, max: max});
      });

      updateMapColors();
    }).catch(function(err) {
      console.error('Failed to load ' + label + ' data:', err);
    });
  }

  loadPollutantData('PM2.5', './data/PM2.5_state_month_2018_2025.csv', 'pm25');
  loadPollutantData('NO2',  './data/no2_state_month_2018_2025.csv',  'no2');
  loadPollutantData('O3',   './data/ozone_state_month_2018_2025.csv','o3');
  loadPollutantData('PM10', './data/PM10_Mass_state_month_2018_2025.csv','pm10');
  loadPollutantData('CO',   './data/co_state_month_2018_2025.csv',   'co');
  loadPollutantData('SO2',  './data/so2_state_month_2018_2025.csv',  'so2');


  var pollutantColorScale = d3.scaleSequential(d3.interpolateYlOrRd).domain([0, 15]);

  function updateLegendGradient(min, max) {
    var legendGradient = d3.select('#legend-gradient');
    legendGradient.selectAll('*').remove();

    var defs = legendGradient.append('defs');
    var gradient = defs.append('linearGradient')
      .attr('id', 'pollutant-gradient')
      .attr('x1', '0%')
      .attr('x2', '100%');

    var numStops = 10;
    for (var i = 0; i <= numStops; i++) {
      var value = min + (i / numStops) * (max - min);
      gradient.append('stop')
        .attr('offset', (i / numStops * 100) + '%')
        .attr('stop-color', pollutantColorScale(value));
    }

    legendGradient.append('rect')
      .attr('width', 180)
      .attr('height', 12)
      .attr('fill', 'url(#pollutant-gradient)')
      .attr('rx', 2);
  }

  function keyFor(year, monthIdx) {
    var mm = String(monthIdx + 1).padStart(2, '0');
    return year + '/' + mm;
  }

  function updateMapColors() {
    var selectedPollutant = d3.select('#pollutant').property('value');
    var selectedYear = d3.select('#year').property('value');

    if (!selectedPollutant || !selectedYear) {
      gMap.selectAll('path.state').style('fill', '#e5edf5');
      d3.select('#color-legend').style('display', 'none');
      return;
    }

    var pollutantConfig = {
      pm25: { name: 'PM₂.₅', unit: 'μg/m³', dataKey: 'pm25' },
      no2:  { name: 'NO₂',   unit: 'ppb',   dataKey: 'no2'  },
      o3:   { name: 'O₃',    unit: 'ppb',   dataKey: 'o3'   },
      pm10: { name: 'PM₁₀',  unit: 'μg/m³', dataKey: 'pm10' },
      co:   { name: 'CO',    unit: 'ppm',   dataKey: 'co'   },
      so2:  { name: 'SO₂',   unit: 'ppb',   dataKey: 'so2'  }
    };
    var config = pollutantConfig[selectedPollutant];
    if (!config) {
      gMap.selectAll('path.state').style('fill', '#e5edf5');
      d3.select('#color-legend').style('display', 'none');
      return;
    }

    var yearRange = yearRanges[config.dataKey].get(selectedYear);
    if (!yearRange) {
      gMap.selectAll('path.state').style('fill', '#e5edf5');
      d3.select('#color-legend').style('display', 'none');
      return;
    }

    pollutantColorScale.domain([yearRange.min, yearRange.max]);
    d3.select('#legend-title').text(config.name + ' (' + config.unit + ')');
    d3.select('#legend-min').text(yearRange.min.toFixed(2));
    d3.select('#legend-max').text(yearRange.max.toFixed(2));
    updateLegendGradient(yearRange.min, yearRange.max);
    d3.select('#color-legend').style('display', 'block');

    var monthIdx = activeMonth ? months.indexOf(activeMonth) : 0;
    var monthCode = keyFor(selectedYear, monthIdx);
    var monthData = pollutantData[config.dataKey].get(monthCode);

    if (!monthData) {
      gMap.selectAll('path.state').style('fill', '#e5edf5');
      d3.select('#color-legend').style('display', 'none');
      return;
    }

    gMap.selectAll('path.state')
      .style('fill', function(d) {
        var stateName = d.properties.name;
        var value = monthData.get(stateName);
        if (value === undefined || isNaN(value)) return '#e5edf5';
        return pollutantColorScale(value);
      });
  }

  function updateMapTitle() {
    const pollutant = document.querySelector('#pollutant').value;
    const year = document.querySelector('#year').value;
    const month = activeMonth;

    const subTitleEl = document.querySelector('.map-sub-title');

    const pollutantName = {
        pm25: "PM₂.₅",
        no2: "NO₂",
        o3: "O₃"
    }[pollutant];


    if (!pollutant || !year || !month) {
    subTitleEl.textContent = "Select pollutant, year & month to explore trends";
    return;
    }

    subTitleEl.textContent = `${pollutantName} — ${year} / ${month}`;

  }

  document.querySelector('#pollutant').addEventListener('change', updateMapTitle);
  document.querySelector('#year').addEventListener('change', updateMapTitle);
  document.body.addEventListener('monthchange', updateMapTitle);

  d3.select('#pollutant').on('change', function() {
    updateMapColors();           // 레이더와는 독립
  });
  d3.select('#year').on('change', function() {
    updateMapColors();
  });

  // ----- AQI 레이더 차트 + 월별 Overall AQI 라인 차트 ----- //

  var radarSvg  = d3.select("#radarChart");
  var radarMeta = d3.select("#radarMeta");

  // 레이더 & 라인에서 함께 쓸 데이터
  var radarData      = new Map();  // key = "State|YYYY-MM" → pollutant AQI들
  var monthlyAQIBySY = new Map();  // key = "State|YYYY" → [{month, overallAQI}]
  var radarLoaded    = false;
  var currentRadarMonth  = 1;      // 현재 선택된 월 (1~12)

  // AQI 색상 스케일 (EPA 기준)
  var aqiColor = d3.scaleThreshold()
    .domain([51, 101, 151, 201, 301])
    .range([
      "#00e400", // 0-50   Good
      "#ffff00", // 51-100 Moderate
      "#ff7e00", // 101-150 Unhealthy for SG
      "#ff0000", // 151-200 Unhealthy
      "#8f3f97", // 201-300 Very Unhealthy
      "#7e0023"  // 301+   Hazardous
    ]);

  // AQI 범례 (레이더 카드 아래)
  function drawAQILegend() {
    var svg = d3.select("#aqiLegendSvg");
    if (svg.empty()) return;

    svg.selectAll("*").remove();

    var g = svg.append("g").attr("transform", "translate(4, 6)");

    var legendData = [
      { label: "0–50\nGood",                max: 50  },
      { label: "51–100\nModerate",          max: 100 },
      { label: "101–150\nUnhealthy for SG", max: 150 },
      { label: "151–200\nUnhealthy",        max: 200 },
      { label: "201–300\nVery Unhealthy",   max: 300 },
      { label: "301+\nHazardous",           max: 500 }
    ];

    var boxW = 70;
    var boxH = 12;
    var gapX = 3;

    var item = g.selectAll("g.legend-item")
      .data(legendData)
      .enter().append("g")
      .attr("class", "legend-item")
      .attr("transform", function(d, i) {
        return "translate(" + (i * (boxW + gapX)) + ",0)";
      });

    item.append("rect")
      .attr("width", boxW)
      .attr("height", boxH)
      .attr("rx", 2)
      .attr("ry", 2)
      .attr("fill", function(d) { return aqiColor(d.max); })
      .attr("stroke", "#e5e7eb")
      .attr("stroke-width", 0.5);

    item.append("text")
      .attr("x", boxW / 2)
      .attr("y", boxH + 9)
      .attr("text-anchor", "middle")
      .attr("class", "aqi-legend-label")
      .selectAll("tspan")
      .data(function(d) { return d.label.split("\n"); })
      .enter().append("tspan")
        .attr("x", boxW / 2)
        .attr("dy", function(_, i) { return i === 0 ? 0 : 10; })
        .text(function(t) { return t; });
  }

  // ===== 레이더 내부 그리기 함수 ===== //
  function drawRadar(data, overallAQI, aqiCol) {
    var w  = +radarSvg.attr("width");
    var h  = +radarSvg.attr("height");
    var cx = w / 2;
    var cy = h / 2 + 5;
    var maxRadius = Math.min(w, h) / 2 - 20;

    var innerHoleR = maxRadius * 0.45; // 가운데 도넛

    var barScale = d3.scaleLinear()
      .domain([0, 300])
      .range([innerHoleR + 6, maxRadius]);

    var cats  = data.map(d => d.name);
    var angle = d3.scaleBand()
      .domain(cats)
      .range([0, 2 * Math.PI])
      .padding(0.25);

    var bw = angle.bandwidth();
    var g  = radarSvg.append("g")
      .attr("transform", "translate(" + cx + "," + cy + ")");

    var gridLevels = [50, 100, 150, 200, 300];
    gridLevels.forEach(function (L) {
      g.append("circle")
        .attr("r", barScale(L))
        .attr("fill", "none")
        .attr("stroke", "#e5e7eb")
        .attr("stroke-width", 0.8);

      g.append("text")
        .attr("x", 0)
        .attr("y", -barScale(L) - 3)
        .attr("text-anchor", "middle")
        .style("font-size", "9px")
        .style("fill", "#94a3b8")
        .text(L);
    });

    var axes = g.selectAll(".axis")
      .data(data)
      .enter().append("g")
      .attr("class", "axis");

    axes.append("line")
      .attr("x1", d => innerHoleR * Math.sin(angle(d.name)))
      .attr("y1", d => -innerHoleR * Math.cos(angle(d.name)))
      .attr("x2", d => barScale(300) * Math.sin(angle(d.name)))
      .attr("y2", d => -barScale(300) * Math.cos(angle(d.name)))
      .attr("stroke", "#cbd5e1")
      .attr("stroke-width", 1);

    axes.append("text")
      .attr("x", d => (barScale(300) + 18) * Math.sin(angle(d.name)))
      .attr("y", d => -(barScale(300) + 18) * Math.cos(angle(d.name)))
      .attr("text-anchor", "middle")
      .style("font-size", "12px")
      .style("font-weight", "500")
      .style("fill", "#0f172a")
      .text(d => d.name);

    var driver = data.reduce((a, b) => (a.value > b.value ? a : b));

    var barArc = d3.arc()
      .innerRadius(innerHoleR)
      .outerRadius(d => barScale(d.value))
      .startAngle(d => angle(d.name) - bw / 2)
      .endAngle(d => angle(d.name) + bw / 2);

    g.selectAll(".radar-bar")
      .data(data)
      .enter().append("path")
      .attr("class", "radar-bar")
      .attr("d", barArc)
      .attr("fill", d => aqiColor(d.value))
      .attr("fill-opacity", d => d === driver ? 0.8 : 0.5)
      .attr("stroke", d => d === driver ? "#111827" : "#ffffff")
      .attr("stroke-width", d => d === driver ? 1.4 : 0.7);

    var tips = g.selectAll(".radar-tip")
      .data(data)
      .enter().append("g")
      .attr("class", "radar-tip")
      .attr("transform", d => {
        var r = barScale(d.value);
        var a = angle(d.name);
        return "translate(" + (r * Math.sin(a)) + "," + (-r * Math.cos(a)) + ")";
      });

    tips.append("circle")
      .attr("r", 3)
      .attr("fill", "#ffffff")
      .attr("stroke", "#0f172a")
      .attr("stroke-width", 0.8);

    tips.append("text")
      .attr("y", -6)
      .attr("text-anchor", "middle")
      .style("font-size", "9px")
      .style("fill", "#0f172a")
      .text(d => Math.round(d.value));

    g.append("circle")
      .attr("r", innerHoleR - 4)
      .attr("fill", "#ffffff");

    g.append("text")
      .attr("text-anchor", "middle")
      .attr("dy", "0.2em")
      .style("font-size", "24px")
      .style("font-weight", "700")
      .style("fill", aqiCol)
      .style("stroke", "#abd5bd")
      .style("stroke-width", "0.5px")
      .text(Math.round(overallAQI));

    g.append("text")
      .attr("text-anchor", "middle")
      .attr("dy", "1.6em")
      .style("font-size", "10px")
      .style("fill", "#6b7280")
      .text("Overall AQI");
  }

  // ===== 위에 표시되는 "월별 Overall AQI" 라인 차트 세팅 ===== //

  var aqiLineSvg = d3.select("#aqiLineChart"),
      aqiLineMargin = {top: 20, right: 10, bottom: 30, left: 40},
      aqiLineWidth  = +aqiLineSvg.attr("width")  - aqiLineMargin.left - aqiLineMargin.right,
      aqiLineHeight = +aqiLineSvg.attr("height") - aqiLineMargin.top  - aqiLineMargin.bottom;

  var gAqiLine = aqiLineSvg.append("g")
      .attr("transform", "translate(" + aqiLineMargin.left + "," + aqiLineMargin.top + ")");

  var xAQI = d3.scaleBand()
      .domain(d3.range(1, 13))
      .range([0, aqiLineWidth])
      .padding(0.2);

  var yAQI = d3.scaleLinear()
      .range([aqiLineHeight, 0]);

  var xAxisAQI = d3.axisBottom(xAQI)
      .tickFormat(function(m) {
        var names = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        return names[m-1];
      });

  var yAxisAQI = d3.axisLeft(yAQI).ticks(4);

  gAqiLine.append("g")
      .attr("class", "x-axis-aqi")
      .attr("transform", "translate(0," + aqiLineHeight + ")")
      .call(xAxisAQI);

  gAqiLine.append("g")
      .attr("class", "y-axis-aqi")
      .call(yAQI);

  gAqiLine.append("text")
      .attr("x", aqiLineWidth / 2)
      .attr("y", -6)
      .attr("text-anchor", "middle")
      .style("font-size", "11px")
      .style("fill", "#64748b")
      .text("Monthly Overall AQI");

  var aqiTooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

  var aqiLineGen = d3.line()
    .x(d => xAQI(d.month) + xAQI.bandwidth() / 2)
    .y(d => yAQI(d.overallAQI))
    .curve(d3.curveMonotoneX);

  var monthNamesShort = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  // ===== MasterDataset_AR.csv 로드 → 레이더 + AQI 라인 모두 여기서 세팅 ===== //

  d3.csv("./data/MasterDataset_AR.csv").then(function(rows) {

    var stateSet = new Set();
    var yearSet  = new Set();

    rows.forEach(function(d) {
      var state = d.state;

      // month: "2025-10" 또는 "2025/10" 모두 처리
      var parts = String(d.month).split(/[-/]/);
      var year  = +parts[0];
      var mm    = +parts[1];

      stateSet.add(state);
      yearSet.add(year);

      var rec = {
        state: state,
        year:  year,
        month_num: mm,
        pm25_aqi: +d.pm25_aqi,
        pm10_aqi: +d.pm10_aqi,
        co_aqi:   +d.co_aqi,
        o3_aqi:   +d.o3_aqi,
        no2_aqi:  +d.no2_aqi,
        so2_aqi:  +d.so2_aqi
      };

      var mmStr = String(mm).padStart(2,'0');
      var key   = state + "|" + year + "-" + mmStr;

      radarData.set(key, rec);

      var overall = d3.max([
        rec.pm25_aqi, rec.pm10_aqi, rec.co_aqi,
        rec.o3_aqi, rec.no2_aqi, rec.so2_aqi
      ].filter(v => !isNaN(v)));

      var keySY = state + "|" + year;
      if (!monthlyAQIBySY.has(keySY)) monthlyAQIBySY.set(keySY, []);
      monthlyAQIBySY.get(keySY).push({
        month: mm,
        overallAQI: overall || 0
      });
    });

    radarLoaded = true;
    console.log("[AQI] loaded", radarData.size, "records");

    var stateList = Array.from(stateSet).sort();
    var yearList  = Array.from(yearSet).sort();

    var stSel = d3.select("#radarState");
    var ySel  = d3.select("#radarYear");
    var mSel  = d3.select("#radarMonth");

    stSel.selectAll("option.stateOpt")
      .data(stateList)
      .enter().append("option")
      .attr("class", "stateOpt")
      .attr("value", d => d)
      .text(d => d);

    ySel.selectAll("option.yearOpt")
      .data(yearList)
      .enter().append("option")
      .attr("class", "yearOpt")
      .attr("value", d => d)
      .text(d => d);

    if (stateList.length) stSel.property("value", stateList[0]);
    if (yearList.length)  ySel.property("value", yearList[0]);
    mSel.property("value", currentRadarMonth);

    stSel.on("change", function() {
      updateAQILineChart();
    });
    ySel.on("change", function() {
      updateAQILineChart();
    });
    mSel.on("change", function() {
      currentRadarMonth = +this.value;
      updateRadarChartExplicit(currentRadarMonth);
      highlightSelectedMonth();
    });

    drawAQILegend();
    updateAQILineChart();   // 초기 렌더
  });

  // ===== 월별 Overall AQI 라인 차트 업데이트 ===== //
  function updateAQILineChart() {
    if (!radarLoaded) return;

    var stateName = d3.select("#radarState").property("value");
    var yearVal   = d3.select("#radarYear").property("value");

    gAqiLine.selectAll(".aqi-overall-line").remove();
    gAqiLine.selectAll(".aqi-point").remove();
    gAqiLine.selectAll(".no-data-text").remove();

    if (!stateName || !yearVal) {
      radarMeta.text("Select a state and year to see AQI trends.");
      return;
    }

    var keySY = stateName + "|" + yearVal;
    var arr   = (monthlyAQIBySY.get(keySY) || []).slice()
                  .sort((a,b) => a.month - b.month);

    if (!arr.length) {
      radarMeta.text("No AQI data for " + stateName + " in " + yearVal + ".");
      gAqiLine.append("text")
        .attr("class", "no-data-text")
        .attr("x", aqiLineWidth / 2)
        .attr("y", aqiLineHeight / 2)
        .attr("text-anchor", "middle")
        .style("fill", "#9ca3af")
        .text("No AQI data available");
      return;
    }

    var maxAQI = d3.max(arr, d => d.overallAQI) || 0;
    yAQI.domain([0, Math.max(100, maxAQI * 1.1)]).nice();

    gAqiLine.select(".y-axis-aqi").transition().duration(300)
      .call(yAxisAQI);

    gAqiLine.select(".x-axis-aqi")
      .call(xAxisAQI)
      .selectAll("text")
      .attr("dy", "1.5em")
      .style("fill", "#475569")
      .style("font-size", "10px");

    gAqiLine.append("path")
      .datum(arr)
      .attr("class", "aqi-overall-line")
      .attr("fill", "none")
      .attr("stroke", "#2563eb")
      .attr("stroke-width", 2)
      .attr("d", aqiLineGen);

    var points = gAqiLine.selectAll(".aqi-point")
      .data(arr, d => d.month);

    var enter = points.enter()
      .append("circle")
      .attr("class", "aqi-point")
      .attr("r", 4)
      .attr("cx", d => xAQI(d.month) + xAQI.bandwidth() / 2)
      .attr("cy", d => yAQI(d.overallAQI))
      .style("fill", "#2563eb")
      .style("stroke", "#ffffff")
      .style("stroke-width", 1.3)
      .style("cursor", "pointer")
      .on("mouseover", function(d) {
        aqiTooltip
          .style("opacity", 0.95)
          .html("<b>" + monthNamesShort[d.month-1] + " " +
                d3.select("#radarYear").property("value") + "</b><br>" +
                "Overall AQI: " + Math.round(d.overallAQI))
          .style("left", (d3.event.pageX + 10) + "px")
          .style("top", (d3.event.pageY - 28) + "px");
      })
      .on("mousemove", function() {
        aqiTooltip
          .style("left", (d3.event.pageX + 10) + "px")
          .style("top", (d3.event.pageY - 28) + "px");
      })
      .on("mouseout", function() {
        aqiTooltip.transition().duration(150).style("opacity", 0);
      })
      .on("click", function(d) {
        currentRadarMonth = d.month;
        d3.select("#radarMonth").property("value", currentRadarMonth);
        updateRadarChartExplicit(currentRadarMonth);
        highlightSelectedMonth();
      });

    points.merge(enter)
      .transition().duration(300)
      .attr("cx", d => xAQI(d.month) + xAQI.bandwidth() / 2)
      .attr("cy", d => yAQI(d.overallAQI));

    points.exit().remove();

    if (!arr.find(d => d.month === currentRadarMonth)) {
      currentRadarMonth = arr[0].month;
      d3.select("#radarMonth").property("value", currentRadarMonth);
    }

    updateRadarChartExplicit(currentRadarMonth);
    highlightSelectedMonth();
  }

  // 라인 차트에서 선택된 월 포인트 강조
  function highlightSelectedMonth() {
    gAqiLine.selectAll(".aqi-point")
      .attr("r", d => d.month === currentRadarMonth ? 6 : 4)
      .style("fill", d => d.month === currentRadarMonth ? "#1d4ed8" : "#2563eb");
  }

  // 특정 monthVal에 대해 레이더 갱신
  function updateRadarChartExplicit(monthVal) {
    if (!radarLoaded) return;

    var stateName = d3.select("#radarState").property("value");
    var yearVal   = d3.select("#radarYear").property("value");

    radarSvg.selectAll("*").remove();

    if (!stateName || !yearVal || !monthVal) {
      radarMeta.text("Select a state, year, and month to see the AQI profile.");
      return;
    }

    var mmStr = String(monthVal).padStart(2,'0');
    var key   = stateName + "|" + yearVal + "-" + mmStr;
    var rec   = radarData.get(key);

    if (!rec) {
      radarMeta.text("No AQI data for " + stateName + " " + yearVal + "-" + mmStr + ".");
      return;
    }

    var series = [
      { name: "PM2.5", value: rec.pm25_aqi },
      { name: "PM10",  value: rec.pm10_aqi },
      { name: "CO",    value: rec.co_aqi   },
      { name: "O3",    value: rec.o3_aqi   },
      { name: "NO2",   value: rec.no2_aqi  },
      { name: "SO2",   value: rec.so2_aqi  }
    ];

    var overallAQI = d3.max(series, d => d.value);
    var aqiCol     = aqiColor(overallAQI);

    drawRadar(series, overallAQI, aqiCol);

    var monthLabel = monthNamesShort[monthVal-1];
  }

  // ===== Mortality line chart 이하 (기존 코드, tooltip border만 수정) =====
  var svgLine = d3.select("#lineChart"),
      margin = {top: 40, right: 70, bottom: 70, left: 100},
      width = +svgLine.attr("width") - margin.left - margin.right,
      height = +svgLine.attr("height") - margin.top - margin.bottom;

  var gLine = svgLine.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var xLine = d3.scaleTime().range([0, width]);
  var yLine = d3.scaleLinear().range([height, 0]);

  var color = d3.scaleOrdinal()
    .domain(["Asthma", "COPD", "IHD"])
    .range([
      "rgba(147,197,253,0.8)",
      "rgba(250,204,21,0.8)",
      "rgba(249,168,212,0.8)"
    ]);

  var xAxis = d3.axisBottom(xLine)
    .ticks(d3.timeYear.every(1))
    .tickFormat(d3.timeFormat("%Y"))
    .tickPadding(8);
  var yAxis = d3.axisLeft(yLine).tickFormat(d3.format(".1f"));

  gLine.append("g").attr("class", "x-axis")
      .attr("transform", "translate(0," + height + ")");
  gLine.append("g").attr("class", "y-axis");

  gLine.append("text")
    .attr("x", width / 2)
    .attr("y", -10)
    .attr("text-anchor", "middle")
    .style("font-weight", "600")
    .text("Yearly Mortality Rate per 100,000 by Disease (2018-2024)");

  gLine.append("text")
    .attr("x", width / 2)
    .attr("y", height + 40)
    .attr("text-anchor", "middle")
    .style("fill", "#64748b")
    .text("Year");

  gLine.append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", -45)
    .attr("x", -height / 2)
    .attr("text-anchor", "middle")
    .style("fill", "#64748b")
    .text("Mortality Rate per 100,000");

  var legend = gLine.append("g")
    .attr("class", "legend")
    .attr("transform", "translate(" + (width + 20) + ", 0)");

  var legendItems = [
    { name: "Asthma", color: "rgba(147,197,253,0.8)" },
    { name: "COPD",  color: "rgba(250,204,21,0.8)" },
    { name: "IHD",   color: "rgba(249,168,212,0.8)" }
  ];

  legend.selectAll("rect")
    .data(legendItems)
    .enter().append("rect")
    .attr("x", 0)
    .attr("y", (d, i) => i * 20)
    .attr("width", 10)
    .attr("height", 10)
    .attr("rx", 2)
    .attr("fill", d => d.color)
    .attr("fill-opacity", 0.9);

  legend.selectAll("text")
    .data(legendItems)
    .enter().append("text")
    .attr("x", 16)
    .attr("y", (d, i) => i * 20 + 9)
    .attr("text-anchor", "start")
    .style("font-size", "11.5px")
    .style("fill", "#334155")
    .text(d => d.name);

  var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("position", "absolute")
    .style("padding", "6px 10px")
    .style("background", "#fff")
    .style("border", "1px solid #ddd")
    .style("border-radius", "6px")
    .style("font-size", "13px")
    .style("pointer-events", "none")
    .style("opacity", 0);

  // --- Mortality + population data ---
  Promise.all([
    d3.csv("./data/copd_final.csv"),
    d3.csv("./data/asthma_final.csv"),
    d3.csv("./data/ihd_final.csv"),
    d3.csv("./data/state_population.csv")
  ]).then(function([copd, asthma, ihd, pop]) {

    copd.forEach(d => d.disease = "COPD");
    asthma.forEach(d => d.disease = "Asthma");
    ihd.forEach(d => d.disease = "IHD");

    var data = copd.concat(asthma, ihd);

    var parseMonth = d3.timeParse("%Y/%m");
    var formatMonth = d3.timeFormat("%Y/%m");

    data.forEach(function(d) {
      d.date = parseMonth(String(d["Month Code"]));
      d.deaths = +d["Deaths"];
      d.state = d["Residence State"];
    });

    var popByStateYear = {};
    pop.forEach(function(d) {
      var state = d.State;
      for (var year = 2018; year <= 2024; year++) {
        var col = String(year);
        var raw = d[col];
        if (!raw) continue;
        var val = +raw.replace(/,/g, "");
        if (!isNaN(val)) {
          popByStateYear[state + "_" + year] = val;
        }
      }
    });

    var allStates = Array.from(new Set(data.map(d => d.state))).sort();
    var diseases = Array.from(new Set(data.map(d => d.disease)));

    var fullMonths = [];
    for (let y = 2018; y <= 2024; y++) {
      for (let m = 1; m <= 12; m++) {
        fullMonths.push(`${y}/${String(m).padStart(2, "0")}`);
      }
    }

    var filledData = [];
    allStates.forEach(state => {
      diseases.forEach(disease => {
        fullMonths.forEach(monthCode => {
          const found = data.find(
            d =>
              d.state === state &&
              d.disease === disease &&
              formatMonth(d.date) === monthCode
          );
          if (found) {
            filledData.push(found);
          } else {
            filledData.push({
              state: state,
              disease: disease,
              date: parseMonth(monthCode),
              deaths: 0
            });
          }
        });
      });
    });

    data = filledData;

    var GLOBAL_MAX = 0;
    allStates.forEach(state => {
      diseases.forEach(disease => {
        d3.range(2018, 2025).forEach(year => {
          let key = state + "_" + year;
          let popVal = popByStateYear[key];
          if (!popVal) return;

          let yearlyDeaths = data.filter(
            d => d.state === state &&
                 d.disease === disease &&
                 d.date.getFullYear() === year
          ).reduce((sum, d) => sum + d.deaths, 0);

          let rate = yearlyDeaths / popVal * 100000;
          if (rate > GLOBAL_MAX) GLOBAL_MAX = rate;
        });
      });
    });

    console.log("Global max mortality rate:", GLOBAL_MAX);

    d3.select("#state")
      .selectAll("option.stateOpt")
      .data(allStates)
      .enter().append("option")
      .attr("value", d => d)
      .text(d => d);

    var allYears = d3.range(2018, 2025);
    xLine.domain(d3.extent(allYears, d => new Date(d, 0, 1)));
    yLine.domain([0, GLOBAL_MAX * 1.1]).nice();

    gLine.select(".x-axis")
      .call(d3.axisBottom(xLine)
        .ticks(d3.timeYear.every(1))
        .tickFormat(d3.timeFormat("%Y"))
        .tickSizeOuter(0)
        .tickPadding(10))
      .selectAll("text")
      .attr("dy", "1.5em")
      .style("fill", "#475569")
      .style("font-size", "12px");

    gLine.select(".y-axis")
      .call(yAxis);

    function updateChart(state) {
      var filtered = data.filter(d => d.state === state);

      var yearly = d3.nest()
        .key(d => d.disease)
        .key(d => {
          const year = d.date.getFullYear();
          return (year <= 2024) ? year : null;
        })
        .rollup(v => d3.sum(v, d => d.deaths))
        .entries(filtered)
        .map(g => ({
          name: g.key,
          values: g.values
            .filter(v => v.key !== "null")
            .map(v => ({ year: +v.key, deaths: v.value }))
            .sort((a, b) => a.year - b.year)
        }));

      if (yearly.length === 0) {
        console.warn("No data for state:", state);
        return;
      }

      yearly.forEach(function(series) {
        series.values.forEach(function(v) {
          var key = state + "_" + v.year;
          var pop = popByStateYear[key];
          if (pop && pop > 0) {
            v.rate = (v.deaths / pop) * 100000;
          } else {
            v.rate = null;
          }
        });

        series.values = series.values.filter(v => v.rate !== null);
      });

      yearly = yearly.filter(s => s.values.length > 0);
      if (!yearly.length) {
        console.warn("No rate data for state:", state);
        return;
      }

      var lineGen = d3.line()
        .x(d => xLine(new Date(d.year, 0, 1)))
        .y(d => yLine(d.rate))
        .curve(d3.curveMonotoneX);

      var lines = gLine.selectAll(".disease-line")
        .data(yearly, d => d.name);

      lines.enter().append("path")
        .attr("class", "disease-line")
        .merge(lines)
        .attr("fill", "none")
        .attr("stroke-width", 1.6)
        .attr("stroke-opacity", 0.9)
        .attr("stroke", d => color(d.name))
        .attr("d", d => lineGen(d.values));

      lines.exit().remove();

      var overlays = gLine.selectAll(".hover-line")
        .data(yearly, d => d.name);

      overlays.enter().append("path")
        .attr("class", "hover-line")
        .merge(overlays)
        .attr("fill", "none")
        .attr("stroke", "transparent")
        .attr("stroke-width", 15)
        .attr("d", d => lineGen(d.values))
        .on("mousemove", function(d) {
          const [mx] = d3.mouse(this);
          const xDate = xLine.invert(mx);
          const year = xDate.getFullYear();
          const nearest = d.values.reduce((a, b) =>
            Math.abs(a.year - year) < Math.abs(b.year - year) ? a : b
          );
          tooltip.transition().duration(50).style("opacity", 0.9);
          tooltip.html(
            `<b>${d.name}</b><br>` +
            `${nearest.year}: ${nearest.rate.toFixed(1)} per 100,000<br>` +
            `Deaths: ${nearest.deaths.toLocaleString()}`
          )
            .style("left", (d3.event.pageX + 10) + "px")
            .style("top", (d3.event.pageY - 28) + "px");
        })
        .on("mouseout", function() {
          tooltip.transition().duration(150).style("opacity", 0);
        });

      overlays.exit().remove();

      var points = gLine.selectAll(".point")
        .data(
          yearly.flatMap(s =>
            s.values.map(v => ({ ...v, name: s.name }))
          ),
          d => d.name + "_" + d.year
        );

      points.exit().remove();

      points = points.enter()
        .append("circle")
        .attr("class", "point")
        .attr("r", 3)
        .attr("fill", d => color(d.name))
        .attr("fill-opacity", 0.9)
        .merge(points);

      points
        .attr("cx", d => xLine(new Date(d.year, 0, 1)))
        .attr("cy", d => yLine(d.rate))
        .on("mouseover", function(d) {
          d3.select(this)
            .transition().duration(80)
            .attr("r", 6);

          tooltip.transition().duration(50).style("opacity", 0.9);
          tooltip.html(
            `<b>${d.name}</b><br>` +
            `${d.year}: ${d.rate.toFixed(1)} per 100,000<br>` +
            `Deaths: ${d.deaths.toLocaleString()}`
          )
            .style("left", (d3.event.pageX + 10) + "px")
            .style("top", (d3.event.pageY - 28) + "px");
        })
        .on("mouseout", function() {
          d3.select(this)
            .transition().duration(80)
            .attr("r", 3);

          tooltip.transition().duration(150).style("opacity", 0);
        });
    }

    d3.select("#state").on("change", function() {
      var st = this.value;
      updateChart(st);
      updateRadarChart(st);   // Update radar chart when state changes
    });

    // --- Aggregate mortality counts by state/month for mini bar chart ---
    var byKey = new Map();

    function addCount(monthCode, stateName, kind, val) {
      if (!byKey.has(monthCode)) byKey.set(monthCode, new Map());
      var m = byKey.get(monthCode);
      if (!m.has(stateName)) m.set(stateName, { asthma: 0, copd: 0, ihd: 0 });
      m.get(stateName)[kind] += val;
    }

    Promise.all([
      d3.json('./data/us-states.json'),
      d3.csv('./data/asthma_final.csv', d => addCount(d['Month Code'], d['Residence State'], 'asthma', +d['Deaths'] || 0)),
      d3.csv('./data/copd_final.csv',   d => addCount(d['Month Code'], d['Residence State'], 'copd',   +d['Deaths'] || 0)),
      d3.csv('./data/ihd_final.csv',    d => addCount(d['Month Code'], d['Residence State'], 'ihd',    +d['Deaths'] || 0))
    ]).then(([geo]) => {
      var states = geo.features;
      gMap.selectAll('path.state')
        .on('mouseover', function(d) {
          renderMiniChart(d.properties.name);
          showPop();
          movePop(d3.event);
        })
        .on('mousemove', function() { movePop(d3.event); })
        .on('mouseout', hidePop);
    });

    function renderMiniChart(stateName) {
      var selectedYear = d3.select('#year').property('value');
      var selectedPollutant = d3.select('#pollutant').property('value');

      var pollutantInfo = d3.select('#pollutant-info');

      if (!selectedYear) {
        popSvg.selectAll('*').remove();
        popTitle.textContent = stateName;
        popSub.textContent = "Select a year to view data";
        pollutantInfo.style('display', 'none').text('');
        return;
      }

      var monthIdx = 0;
      var key = keyFor(selectedYear, monthIdx);

      var pollutantConfig = {
        pm25: { name: 'PM₂.₅', unit: 'μg/m³', dataKey: 'pm25' },
        no2:  { name: 'NO₂',   unit: 'ppb',   dataKey: 'no2'  },
        o3:   { name: 'O₃',    unit: 'ppb',   dataKey: 'o3'   }
      };

      if (selectedPollutant && pollutantConfig[selectedPollutant]) {
        var config = pollutantConfig[selectedPollutant];
        var monthData = pollutantData[config.dataKey].get(key);
        var pollutantValue = monthData ? (monthData.get(stateName) || 0) : 0;
        var displayVal = (pollutantValue === 0)
          ? 'Not Available'
          : pollutantValue.toFixed(2) + ' ' + config.unit;

        pollutantInfo
          .style('display', 'block')
          .text(config.name + ': ' + displayVal);
      } else {
        pollutantInfo.style('display', 'none').text('');
      }

      var rec = (byKey.get(key) || new Map()).get(stateName) || { asthma: 0, copd: 0, ihd: 0 };

      popTitle.textContent = stateName;
      popSub.textContent = `Jan ${selectedYear}`;

      var dataBars = [
        { label: 'Asthma', cls: 'asthma', value: rec.asthma },
        { label: 'COPD',   cls: 'copd',   value: rec.copd },
        { label: 'IHD',    cls: 'ihd',    value: rec.ihd }
      ];

      var W = 240, H = 150, m = { top: 6, right: 8, bottom: 28, left: 36 };
      var iw = W - m.left - m.right, ih = H - m.top - m.bottom;

      popSvg.selectAll('*').remove();
      var g = popSvg.append('g').attr('transform', `translate(${m.left},${m.top})`);

      var x = d3.scaleBand().domain(dataBars.map(d => d.label)).range([0, iw]).padding(0.35);
      var y = d3.scaleLinear()
              .domain([0, (d3.max(dataBars, d => d.value) || 1) * 1.1])
              .range([ih, 0]);

      g.append('g')
        .attr('class', 'axis axis--x')
        .attr('transform', `translate(0,${ih})`)
        .call(d3.axisBottom(x).tickSize(0));
      g.selectAll('.axis--x text')
        .attr('dy', '1.6em');

      g.append('g')
        .attr('class', 'axis axis--y')
        .call(d3.axisLeft(y).ticks(4).tickSize(-iw));

      g.selectAll('rect.bar')
        .data(dataBars)
        .enter().append('rect')
        .attr('class', d => 'bar ' + d.cls)
        .attr('x', d => x(d.label))
        .attr('y', d => y(d.value))
        .attr('width', x.bandwidth())
        .attr('height', d => ih - y(d.value))
        .attr('fill', d => color(d.label))
        .attr('fill-opacity', 0.9)
        .attr('rx', 3);

      g.selectAll('text.value')
        .data(dataBars)
        .enter().append('text')
        .attr('class', 'value')
        .attr('x', d => x(d.label) + x.bandwidth() / 2)
        .attr('y', d => y(d.value) - 6)
        .attr('text-anchor', 'middle')
        .style('font-size', '11px')
        .style('font-weight', '500')
        .style('fill', '#000000')
        .text(d => d.value.toLocaleString());
    }
  });

})();
</script>
</body>
</html>
